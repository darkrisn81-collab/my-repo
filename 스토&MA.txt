
//|                                Stochastic4StrategyEA.mq5         |
//|                   4가지 독립 전략 (양방향 포지션 가능)            |
//|                   v3.1 - 포지션 제한 및 시간대 필터 추가          |
//+------------------------------------------------------------------+
#property copyright "Copyright 2025"
#property version   "3.10"
#property description "Email:darkrisn81@gmail.com";

#include <Trade\Trade.mqh>

//--- 입력 파라미터
input group "=== 기본 설정 ==="
input double   LotSize = 0.1;              // 거래 로트 크기
input int      MagicNumber_BuyBasic = 1001;    // 매수 기본 매직넘버
input int      MagicNumber_BuyTrend = 1002;    // 매수 추세 매직넘버
input int      MagicNumber_SellBasic = 2001;   // 매도 기본 매직넘버
input int      MagicNumber_SellTrend = 2002;   // 매도 추세 매직넘버

input group "=== Stochastic 설정 ==="
input int      Stoch_K = 23;               // %K 주기
input int      Stoch_D = 4;                // %D 주기
input int      Stoch_Slowing = 4;          // Slowing

input group "=== 상단 Moving Average 설정 ==="
input int      MA1_Period = 69;            // MA1 주기 (LWMA)
input int      MA2_Period = 60;            // MA2 주기 (SMA)
input int      MA3_Period = 23;            // MA3 주기 (LWMA) - 추세 전략용

input group "=== 하단 지표 설정 ==="
input int      StochMA_Period = 6;         // Stoch에 적용할 MA 주기
input int      BB_Period = 14;             // BB 주기
input double   BB_Deviation = 0.5;         // BB 편차

input group "=== 기준선 설정 ==="
input double   Level_Low = 20.0;           // 하단 기준선 (20)
input double   Level_BuyCancel = 40.0;     // 매수 대기 해제선 (40)
input double   Level_SellCancel = 60.0;    // 매도 대기 해제선 (60)
input double   Level_High = 80.0;          // 상단 기준선 (80)

input group "=== SL/TP 설정 ==="
input bool     UseSLTP = false;            // SL/TP 사용 여부
input int      StopLoss = 500;             // 손절 (포인트, 0=미사용)
input int      TakeProfit = 1000;          // 익절 (포인트, 0=미사용)
input int      SwingBars = 10;      // SL 계산용 최근 n봉
input double   OffsetPoints = 50;   // SL 오프셋 포인트


input group "=== SL 연속 손실 방지 ==="
input int      SL_CooldownMinutes = 10;    // SL 재발생 시 거래 정지 시간 (분)

input group "=== 추세 전략 SL 정지 ==="
input int      TrendSL_BlockMinutes = 20;  // 추세 전략 SL 2회 시 정지 시간 (분)

input group "=== 기본 전략 진입 대기 ==="
input int      BasicEntryWaitMinutes = 3;  // 신호 완성 후 진입 대기 시간 (분)

input group "=== 추세 전략 포지션 제한 ==="
input int      MaxTrendPositions = 3;      // 추세 전략 최대 포지션 수 (3~5 권장)
input int      TimeAttackMinutes = 8;      // 포지션 만료 시 강제 청산 시간 (분, 6~10 권장)

input group "=== 추세 전략 시간대 제한 (한국시간 기준) ==="
input bool     UseTrendTimeFilter = true;      // 추세 전략 시간 필터 사용
input int      Trend_Session1_Start = 8;       // 세션1 시작 (09:00)
input int      Trend_Session1_End = 12;        // 세션1 종료 (11:00)
input int      Trend_Session2_Start = 14;      // 세션2 시작 (14:00)
input int      Trend_Session2_End = 18;        // 세션2 종료 (18:00)
input int      Trend_Session3_Start = 20;      // 세션3 시작 (21:00)
input int      Trend_Session3_End = 24;        // 세션3 종료 (24:00)

//--- 전역 변수
CTrade trade;
int stochHandle;
int ma1Handle;
int ma2Handle;
int ma3Handle;

// 데이터 배열
double stochMain[];
double stochSignal[];
double ma1Values[];
double ma2Values[];
double ma3Values[];
double stochMA[];
double bbUpper[];
double bbMiddle[];
double bbLower[];

//--- 매수 기본 전략 상태
bool buyBasic_Waiting = false;
int buyBasic_CrossCount = 0;
bool buyBasic_Success1 = false;
bool buyBasic_Success2 = false;
bool buyBasic_ReadyToEnter = false;
datetime buyBasic_ReadyTime = 0;

//--- 매도 기본 전략 상태
bool sellBasic_Waiting = false;
int sellBasic_CrossCount = 0;
bool sellBasic_Success1 = false;
bool sellBasic_Success2 = false;
bool sellBasic_ReadyToEnter = false;
datetime sellBasic_ReadyTime = 0;

//--- 매수 추세 전략 상태
bool buyTrend_BelowMA23 = false;
datetime buyTrend_LastSL = 0;
int buyTrend_SLCount = 0;
bool buyTrend_Blocked = false;
datetime buyTrend_BlockUntil = 0;
datetime buyTrend_FirstPositionTime = 0;  // 첫 포지션 진입 시간
bool buyTrend_TimeAttackActive = false;   // 타임어택 활성화

//--- 매도 추세 전략 상태
bool sellTrend_AboveMA23 = false;
datetime sellTrend_LastSL = 0;
int sellTrend_SLCount = 0;
bool sellTrend_Blocked = false;
datetime sellTrend_BlockUntil = 0;
datetime sellTrend_FirstPositionTime = 0;
bool sellTrend_TimeAttackActive = false;

//--- SL 연속 손실 방지 시스템
datetime lastSLTime = 0;
bool tradingBlocked = false;
datetime blockUntilTime = 0;

//+------------------------------------------------------------------+
//| 함수 시스템 가동 준비                                 |
//+------------------------------------------------------------------+
int OnInit()
{
   stochHandle = iStochastic(_Symbol, PERIOD_CURRENT, 
                            Stoch_K, Stoch_D, Stoch_Slowing,
                            MODE_LWMA, STO_LOWHIGH);
   
   ma1Handle = iMA(_Symbol, PERIOD_CURRENT, MA1_Period, 0, MODE_LWMA, PRICE_CLOSE);
   ma2Handle = iMA(_Symbol, PERIOD_CURRENT, MA2_Period, 0, MODE_SMA, PRICE_CLOSE);
   ma3Handle = iMA(_Symbol, PERIOD_CURRENT, MA3_Period, 0, MODE_LWMA, PRICE_CLOSE);
   
   if(stochHandle == INVALID_HANDLE || ma1Handle == INVALID_HANDLE || 
      ma2Handle == INVALID_HANDLE || ma3Handle == INVALID_HANDLE)
   {
      Print("지표 생성 실패");
      return(INIT_FAILED);
   }
   
   ArraySetAsSeries(stochMain, true);
   ArraySetAsSeries(stochSignal, true);
   ArraySetAsSeries(ma1Values, true);
   ArraySetAsSeries(ma2Values, true);
   ArraySetAsSeries(ma3Values, true);
   ArraySetAsSeries(stochMA, true);
   ArraySetAsSeries(bbUpper, true);
   ArraySetAsSeries(bbMiddle, true);
   ArraySetAsSeries(bbLower, true);
   
   Print("=== EA 초기화 완료 v3.1 ===");
   Print("전략: 4가지 독립 전략 (양방향 포지션 가능)");
   Print("추세 전략 최대 포지션: ", MaxTrendPositions);
   Print("타임어택: ", TimeAttackMinutes, "분");
      if(UseTrendTimeFilter)
      PrintFormat("추세 전략 시간대: %02d~%02d, %02d~%02d, %02d~%02d (한국시간)", 
                  Trend_Session1_Start, Trend_Session1_End,
                  Trend_Session2_Start, Trend_Session2_End,
                  Trend_Session3_Start, Trend_Session3_End);
   
   return(INIT_SUCCEEDED);
}

//+------------------------------------------------------------------+
//| 함수 시스템 가동 종료                             |
//+------------------------------------------------------------------+
void OnDeinit(const int reason)
{
   IndicatorRelease(stochHandle);
   IndicatorRelease(ma1Handle);
   IndicatorRelease(ma2Handle);
   IndicatorRelease(ma3Handle);
   Print("EA 종료");
}

//+------------------------------------------------------------------+
//|실시간 감시 및 실행 함수                                           |
//+------------------------------------------------------------------+
void OnTick()
{
   static datetime lastBarTime = 0;
